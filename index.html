<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğ“‘ğ“»ğ“¸ğ“¬ğ“´_ğ“šğ“²ğ“·ğ“° ã® ğ““ğ“’ ç™¼ç¥¨ç³»çµ±</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        header {
            background: #007bff;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between; 
            align-items: center;
            position: relative; 
        }

        header h1 {
            margin: 0;
            font-size: 1.5em;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        #auth-controls {
            z-index: 10;
        }

        /* ç¢ºä¿æ‰€æœ‰ H2 æ¨™é¡Œç½®ä¸­ */
        h2 {
            text-align: center;
            margin-top: 0;
        }
        
        /* æ–°å¢ï¼šå°‡ç™¼ç¥¨å°çä¸­å¿ƒæ¨™é¡Œæ”¾å¤§ç½®ä¸­ */
        h2#center-title {
            font-size: 2.2em; /* æ”¾å¤§å­—é«” */
            font-weight: bold;
            color: #dc3545; /* çµ¦äºˆé†’ç›®çš„é¡è‰² */
            margin-bottom: 25px;
        }
        
        button {
            padding: 15px 25px; 
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 10px;
            white-space: nowrap; 
            transition: background 0.3s;
        }

        button:hover {
            background: #218838;
        }

        .secondary-btn {
            background: #6c757d;
        }

        .secondary-btn:hover {
            background: #5a6268;
        }

        main {
            padding: 25px;
            max-width: 700px; /* é›»è…¦ç‰ˆæœ€å¤§å¯¬åº¦ */
            margin: 20px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .page {
            display: none; 
        }

        .page.active {
            display: block; 
        }

        form label {
            display: block; /* è®“ label ç¨ç«‹ä½”ä¸€è¡Œ */
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* èª¿æ•´å…¨åŸŸè¼¸å…¥æ¡†å’Œä¸‹æ‹‰é¸å–®å¤§å° */
        form input[type="text"],
        form input[type="password"],
        select { 
            width: 100%; /* é è¨­ä½”æ»¿å®¹å™¨ */
            padding: 12px; 
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; 
            font-size: 1em;
            display: block; 
        }
        
        #new-invoice-number {
             width: 50%; /* ç™»å…¥å¾Œçš„å„²å­˜ç™¼ç¥¨è¼¸å…¥æ¡†ï¼Œå¯¬åº¦æ¸›åŠ */
        }
        
        /* ---------------------------------- */
        /* ä¸­çè™Ÿç¢¼å…¬å‘Šå€å¡Šæ¨£å¼ (é¡¯ç¤ºè™Ÿç¢¼çš„å®¹å™¨) */
        /* ---------------------------------- */
        #winning-numbers-board {
            border: 2px solid #dc3545; /* å¼·èª¿é¡è‰² */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            background-color: #fff3f3; /* æ·ºç´…è‰²èƒŒæ™¯ */
        }
        #winning-numbers-board h3 {
             color: #dc3545;
             border-bottom: 2px solid #dc3545;
             padding-bottom: 5px;
             margin-top: 0;
        }
        /* å…¬å‘Šå€æœŸåˆ¥é¸æ“‡ç¾¤çµ„ */
        #announcement-term-group {
             display: flex;
             align-items: center;
             gap: 10px;
             margin-bottom: 15px;
        }
        #announcement-term-group label {
             display: inline-block;
             margin: 0;
             flex-shrink: 0;
             font-weight: normal; 
        }
        #winning-term-select-announcement {
             flex-grow: 1;
             width: auto;
             margin: 0;
        }
        
        /* çé …åç¨±æ¨£å¼ */
        .prize-row {
            display: flex;
            margin: 8px 0;
            font-size: 1.1em;
            font-weight: bold;
        }
        .prize-label {
            width: 150px; /* å›ºå®šçé …åç¨±å¯¬åº¦ */
            flex-shrink: 0;
        }
        /* è™Ÿç¢¼/ä½”ä½ç¬¦çš„æ¨£å¼ */
        .prize-value {
            color: #007bff;
            font-family: monospace;
            font-size: 1.2em;
            font-weight: bold;
        }


        /* ---------------------------------- */
        /* å–®å¼µå°çå€å¡Šçš„ PC/å¤§è¢å¹• ä½ˆå±€ */
        /* ---------------------------------- */
        #manual-check-area {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 6px;
            margin-top: 30px;
        }
        
        /* æœŸåˆ¥é¸æ“‡çµ„ä»¶ (Label å’Œ Select åœ¨åŒä¸€è¡Œ) */
        #term-select-group {
             display: flex;
             align-items: center;
             gap: 10px;
             margin-top: 15px; 
        }
        #term-select-group label {
            display: inline-block; 
            margin-top: 0;
            margin-bottom: 0;
            flex-shrink: 0;
            width: auto;
        }
        #winning-term-select { 
             flex-grow: 1; 
             width: auto; 
             margin-top: 0;
             margin-bottom: 0;
        }
        
        /* ç™¼ç¥¨è™Ÿç¢¼è¼¸å…¥å’ŒæŒ‰éˆ• (ä¸¦æ’) */
        .input-group {
            display: flex; 
            align-items: stretch; 
            gap: 10px; 
            margin-top: 5px; 
        }
        
        /* ç™¼ç¥¨è™Ÿç¢¼è¼¸å…¥æ¡†ï¼šè®Šå¤§è®Šå¯¬ */
        #invoice-number {
             flex-grow: 1; 
             width: auto; 
             margin-top: 0;
             margin-bottom: 0;
             padding: 15px; 
             font-size: 1.1em;
        }
        
        /* å°çæŒ‰éˆ•ï¼šèˆ‡è¼¸å…¥æ¡†å°é½Š */
        #manual-check-btn {
            flex-shrink: 0;
            margin-top: 0;
            padding: 15px 25px; 
            height: auto; 
        }
        
        /* ---------------------------------- */
        /* æ‰‹æ©ŸéŸ¿æ‡‰å¼èª¿æ•´ (å°æ–¼ 600px å¯¬åº¦çš„è¢å¹•) */
        /* ---------------------------------- */
        @media (max-width: 600px) {
            header h1 {
                font-size: 1.2em; /* æ¨™é¡Œå°ä¸€é» */
            }
            main {
                margin: 0; /* æ‰‹æ©Ÿä¸Šç§»é™¤å·¦å³é‚Šç•Œ */
                padding: 15px;
                max-width: 100%;
                border-radius: 0;
            }

            /* æœŸåˆ¥é¸æ“‡ï¼šè®“ label ä½”ä¸€è¡Œï¼Œselect ä½”ä¸€è¡Œ (é¿å…å£“ç¸®) */
            #term-select-group, #announcement-term-group {
                display: block;
            }
            #term-select-group label, #announcement-term-group label {
                width: 100%;
                margin-top: 5px;
            }
            #winning-term-select, #winning-term-select-announcement {
                margin-bottom: 5px;
            }

            /* ç™¼ç¥¨è™Ÿç¢¼å’ŒæŒ‰éˆ•ï¼šä¸Šä¸‹å‚ç›´æ’åˆ— (é¿å…å£“ç¸®) */
            .input-group {
                display: block; /* è®Šå›å‚ç›´æ’åˆ— */
            }

            #invoice-number {
                width: 100%; /* ä½”æ»¿æ•´è¡Œ */
                margin-bottom: 10px;
            }

            #manual-check-btn {
                width: 100%; /* æŒ‰éˆ•ä¹Ÿä½”æ»¿æ•´è¡Œ */
                margin-top: 0;
                margin-bottom: 15px;
                padding: 15px 0; /* å‚ç›´å¡«å…… */
            }
            
            #new-invoice-number {
                 width: 100%; /* å„²å­˜ç™¼ç¥¨è¼¸å…¥æ¡†ä½”æ»¿æ•´è¡Œ */
            }
            
            /* æ‰‹æ©Ÿä¸Šï¼Œçé …åç¨±ä¸å›ºå®šå¯¬åº¦ */
            .prize-label {
                width: auto;
                flex-shrink: 1;
            }
        }

        /* ---------------------------------- */
        /* åˆ—è¡¨å’Œæç¤ºè¨Šæ¯æ¨£å¼ (ä¸è®Š) */
        /* ---------------------------------- */
        #result-message, #bulk-result-message, #save-message {
            font-weight: bold;
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #eee;
        }
        
        #saved-invoices-list {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
        }
        
        #saved-invoices-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
            font-weight: bold;
        }
        
        .delete-btn {
            background: none;
            color: red;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 0; 
        }
        .delete-btn:hover {
            color: darkred;
            background: #ffe6e6;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <header>
        <h1>ğ“‘ğ“»ğ“¸ğ“¬ğ“´_ğ“šğ“²ğ“·ğ“° ã® ğ““ğ“’ ç™¼ç¥¨ç³»çµ±</h1> 
        <div id="auth-controls">
            <button id="login-btn">ç™»å…¥</button>
        </div>
    </header>

    <main>
        <section id="invoice-section" class="page active">
            <h2 id="center-title">ç™¼ç¥¨å°çå…¬å‘Š</h2>
            
            <div id="winning-numbers-board">
                 <h3>ä¸­çè™Ÿç¢¼å…¬å‘Š</h3>
                 
                 <div id="announcement-term-group">
                    <label for="winning-term-select-announcement">è«‹é¸æ“‡é–‹çæœŸåˆ¥ï¼š</label>
                     <select id="winning-term-select-announcement" onchange="updateAnnouncementNumbers()">
                        </select>
                 </div>
                 
                 <div class="prize-row">
                     <span class="prize-label">ç‰¹çè™Ÿç¢¼ï¼š</span>
                     <span class="prize-value" id="special-prize-number"></span>
                 </div>
                 <div class="prize-row">
                     <span class="prize-label">é ­çè™Ÿç¢¼ï¼š</span>
                     <span class="prize-value" id="first-prize-number"></span>
                 </div>
                 <div class="prize-row">
                     <span class="prize-label">äºŒçè™Ÿç¢¼ï¼š</span>
                     <span class="prize-value" id="second-prize-number"></span>
                 </div>
                 <div class="prize-row">
                     <span class="prize-label">ä¸‰çè™Ÿç¢¼ï¼š</span>
                     <span class="prize-value" id="third-prize-number"></span>
                 </div>
            </div>
            
            <div id="invoice-management" style="display: none;">
                <h3>æˆ‘çš„ç™¼ç¥¨ç®¡ç†</h3>
                <label for="new-invoice-number">æ–°å¢ç™¼ç¥¨è™Ÿç¢¼ (8ç¢¼):</label>
                <input type="text" id="new-invoice-number" maxlength="8" pattern="\d{8}">
                <button onclick="saveInvoice()">å„²å­˜ç™¼ç¥¨</button>
                <p id="save-message"></p>

                <hr>
                
                <h4>å·²å„²å­˜ç™¼ç¥¨ (<span id="invoice-count">0</span> å¼µ)</h4>
                <ul id="saved-invoices-list">
                    </ul>
                
                <hr>
                
                <h3>è‡ªå‹•å°ç</h3>
                <label for="winning-term-select-bulk">è«‹é¸æ“‡é–‹çæœŸåˆ¥ (å°æ¯”æ‰€æœ‰å„²å­˜ç™¼ç¥¨):</label>
                 <select id="winning-term-select-bulk">
                    </select>
                <button onclick="checkAllInvoices()" style="background: #dc3545;">è‡ªå‹•å°ç</button>
                <p id="bulk-result-message" style="font-size: 1.2em;"></p>
            </div>
            
            <div id="manual-check-area">
                 <h3>å–®å¼µç™¼ç¥¨å°ç</h3>
                 
                 <div id="term-select-group">
                     <label for="winning-term-select">è«‹é¸æ“‡é–‹çæœŸåˆ¥ (å–®å¼µå°ç):</label>
                     <select id="winning-term-select">
                        </select>
                 </div>

                <label for="invoice-number">è¼¸å…¥æ‚¨çš„ç™¼ç¥¨è™Ÿç¢¼ (8ç¢¼):</label>
                <div class="input-group">
                    <input type="text" id="invoice-number" maxlength="8" pattern="\d{8}" required>
                    <button onclick="checkWinning()" id="manual-check-btn">å°ç</button>
                </div>
                 <p id="result-message"></p>
            </div>
        </section>

        <section id="login-section" class="page">
            <h2>ä½¿ç”¨è€…ç™»å…¥</h2>
            <form id="login-form">
                <label for="login-username">ä½¿ç”¨è€…åç¨±:</label>
                <input type="text" id="login-username" required>
                
                <label for="login-password">å¯†ç¢¼:</label>
                <input type="password" id="login-password" required>
                
                <button type="submit">ç™»å…¥</button>
            </form>
            <button id="show-register-btn" class="secondary-btn">è¨»å†Šæ–°å¸³è™Ÿ</button>
        </section>

        <section id="register-section" class="page">
            <h2>æ–°å¸³è™Ÿè¨»å†Š</h2>
            <form id="register-form">
                <label for="reg-username">ä½¿ç”¨è€…åç¨± (ä¸­/è‹±æ–‡):</label>
                <input type="text" id="reg-username" required>
                
                <label for="reg-password">å¯†ç¢¼ (è‡³å°‘4å€‹å­—å…ƒï¼Œè‹±æ–‡/æ•¸å­—):</label>
                <input type="password" id="reg-password" minlength="4" required>
                
                <label for="reg-confirm-password">ç¢ºèªå¯†ç¢¼:</label>
                <input type="password" id="reg-confirm-password" required>
                
                <button type="submit">è¨»å†Š</button>
            </form>
            <button id="back-to-login-btn" class="secondary-btn">è¿”å›ç™»å…¥</button>
            <p id="register-message" style="color: red;"></p>
        </section>
    </main>

    <script>
        // --- localStorage éµå ---
        const LS_USERS = 'invoiceSystemUsers';
        const LS_INVOICES = 'invoiceSystemInvoices';
        const LS_CURRENT_USER = 'invoiceSystemCurrentUser';
        
        // --- æ ¸å¿ƒè³‡æ–™åº« (å¾ localStorage è¼‰å…¥ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é è¨­å€¼) ---
        
        // 1. è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
        let users;
        try {
             users = JSON.parse(localStorage.getItem(LS_USERS)) || { 'admin': 'Brock_king' };
        } catch (e) {
             console.error("ç„¡æ³•è§£æå„²å­˜çš„ä½¿ç”¨è€…è³‡æ–™:", e);
             users = { 'admin': 'Brock_king' };
        }

        // 2. è¼‰å…¥ç™¼ç¥¨è³‡æ–™
        let userInvoices;
        try {
             userInvoices = JSON.parse(localStorage.getItem(LS_INVOICES)) || { 'admin': [] };
        } catch (e) {
             console.error("ç„¡æ³•è§£æå„²å­˜çš„ç™¼ç¥¨è³‡æ–™:", e);
             userInvoices = { 'admin': [] };
        }
        
        // 3. å„²å­˜æ•¸æ“šåˆ° localStorage çš„é€šç”¨å‡½æ•¸
        function saveUserData() {
             localStorage.setItem(LS_USERS, JSON.stringify(users));
             localStorage.setItem(LS_INVOICES, JSON.stringify(userInvoices));
        }

        // æ¨¡æ“¬ä¸­çè™Ÿç¢¼ï¼šç‰¹çã€é ­ç(ä¸‰çµ„) - æ•¸æ“š**åªç”¨æ–¼å°çé‚è¼¯**
        // åƒ…ä¿ç•™ 202510 (10æœˆç‰¹åˆ¥ç) çš„è³‡æ–™
        const allWinningNumbers = {
            '202510': { term: '114å¹´09-10æœˆç‰¹åˆ¥ç', special: '69541322', first: [] }, 
        };
        
        // --- ç‹€æ…‹è®Šæ•¸ (å¾ localStorage è¼‰å…¥ç›®å‰çš„ç™»å…¥ç‹€æ…‹) ---
        let currentUser = localStorage.getItem(LS_CURRENT_USER);
        let isAuthenticated = !!currentUser && users.hasOwnProperty(currentUser);
        
        // --- é é¢å…ƒç´ ç²å– ---
        const authControls = document.getElementById('auth-controls');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const invoiceManagement = document.getElementById('invoice-management');
        const savedInvoicesList = document.getElementById('saved-invoices-list');
        const invoiceCountSpan = document.getElementById('invoice-count');
        const newInvoiceInput = document.getElementById('new-invoice-number');
        const saveMessage = document.getElementById('save-message');
        const bulkResultMessage = document.getElementById('bulk-result-message');
        const winningSelectBulk = document.getElementById('winning-term-select-bulk');
        const winningSelectSingle = document.getElementById('winning-term-select'); 
        const winningSelectAnnouncement = document.getElementById('winning-term-select-announcement');
        const specialPrizeNum = document.getElementById('special-prize-number');
        const firstPrizeNum = document.getElementById('first-prize-number');
        const secondPrizeNum = document.getElementById('second-prize-number');
        const thirdPrizeNum = document.getElementById('third-prize-number');


        // --- é é¢åˆ‡æ›å‡½å¼ ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        // --- è¼”åŠ©å‡½å¼ï¼šç™¼ç¥¨å°çæ ¸å¿ƒé‚è¼¯ ---
        function isWinning(invNo, winningData) {
            if (!winningData) return false;
            
            // æª¢æŸ¥ç‰¹ç
            if (invNo === winningData.special) return true;
            
            // æª¢æŸ¥é ­çä¸‰çµ„è™Ÿç¢¼ (å¦‚æœé ­çé™£åˆ—ç‚ºç©ºï¼Œå‰‡è·³é)
            if (winningData.first && winningData.first.includes(invNo)) return true;

            const lastThree = invNo.slice(-3);
            
            // åªæœ‰ç•¶ç‰¹çå’Œé ­çæœ‰è™Ÿç¢¼æ™‚ï¼Œæ‰æª¢æŸ¥æœ«ä¸‰ç¢¼
            const winningLastThree = [];
            if (winningData.special) {
                winningLastThree.push(winningData.special.slice(-3));
            }
            if (winningData.first && winningData.first.length > 0) {
                 winningData.first.map(n => n.slice(-3)).forEach(t => winningLastThree.push(t));
            }

            const uniqueWinningLastThree = [...new Set(winningLastThree)];
            
            // æª¢æŸ¥æœ«ä¸‰ç¢¼
            return uniqueWinningLastThree.includes(lastThree);
        }
        
        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå‹•æ…‹ç”Ÿæˆæœˆä»½é¸å–® ---
        function generateMonthOptions() {
            // ç¢ºä¿é¸å–®ä»¥æœ€æ–°çš„æœŸåˆ¥åœ¨æœ€å‰é¢
            const sortedKeys = Object.keys(allWinningNumbers).sort((a, b) => b.localeCompare(a));
            const options = [];

            sortedKeys.forEach(monthKey => {
                 if (allWinningNumbers[monthKey]) {
                    const option = document.createElement('option');
                    // é¡¯ç¤ºæœŸåˆ¥åç¨±
                    option.textContent = allWinningNumbers[monthKey].term; 
                    option.value = monthKey;
                    options.push(option);
                }
            });
            
            // å°‡é¸é …åˆ†åˆ¥å¡«å…¥ä¸‰å€‹é¸å–®
            winningSelectAnnouncement.innerHTML = '';
            winningSelectBulk.innerHTML = '';
            winningSelectSingle.innerHTML = '';
            
            if (options.length === 0) {
                 const defaultOption = document.createElement('option');
                 defaultOption.textContent = 'ç„¡å¯ç”¨æœŸåˆ¥';
                 defaultOption.value = '';
                 
                 winningSelectAnnouncement.appendChild(defaultOption.cloneNode(true));
                 winningSelectBulk.appendChild(defaultOption.cloneNode(true));
                 winningSelectSingle.appendChild(defaultOption.cloneNode(true));
            } else {
                 options.forEach(opt => {
                    winningSelectAnnouncement.appendChild(opt.cloneNode(true));
                    winningSelectBulk.appendChild(opt.cloneNode(true));
                    winningSelectSingle.appendChild(opt.cloneNode(true));
                });
            }

            // åˆå§‹æ™‚æ›´æ–°å…¬å‘Šå€å¡Šçš„è™Ÿç¢¼ 
            updateAnnouncementNumbers();
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ›´æ–°å…¬å‘Šå€å¡Šçš„è™Ÿç¢¼é¡¯ç¤º ---
        window.updateAnnouncementNumbers = function() {
            const selectedMonthKey = winningSelectAnnouncement.value;
            const winningData = allWinningNumbers[selectedMonthKey];
            
            if (!winningData) {
                specialPrizeNum.textContent = 'ç„¡è³‡æ–™';
                firstPrizeNum.textContent = 'ç„¡è™Ÿç¢¼';
                secondPrizeNum.textContent = 'ç„¡è™Ÿç¢¼';
                thirdPrizeNum.textContent = 'ç„¡è™Ÿç¢¼';
                return;
            }

            // 1. ç‰¹çè™Ÿç¢¼ (æª¢æŸ¥æ˜¯å¦å­˜åœ¨)
            specialPrizeNum.textContent = winningData.special || 'ç„¡è™Ÿç¢¼';
            
            // 2. é ­çè™Ÿç¢¼ (å¦‚æœæœ‰è™Ÿç¢¼å‰‡é¡¯ç¤ºï¼Œå¦å‰‡é¡¯ç¤ºã€Œç„¡è™Ÿç¢¼ã€)
            if (winningData.first && winningData.first.length > 0) {
                 firstPrizeNum.textContent = winningData.first.join(', ');
            } else {
                 firstPrizeNum.textContent = 'ç„¡è™Ÿç¢¼';
            }
            
            // 3. äºŒçè™Ÿç¢¼ (æ‚¨çš„è¦æ±‚æ˜¯åªé¡¯ç¤ºç‰¹çè™Ÿç¢¼ï¼Œå› æ­¤é€™è£¡é¡¯ç¤ºã€Œç„¡è™Ÿç¢¼ã€)
            secondPrizeNum.textContent = 'ç„¡è™Ÿç¢¼';
            
            // 4. ä¸‰çè™Ÿç¢¼
            thirdPrizeNum.textContent = 'ç„¡è™Ÿç¢¼';
        }
        
        // --- è¼”åŠ©å‡½å¼ï¼šæ¸²æŸ“å·²å„²å­˜ç™¼ç¥¨åˆ—è¡¨ ---
        function renderSavedInvoices() {
            savedInvoicesList.innerHTML = '';
            const invoices = userInvoices[currentUser] || [];
            invoiceCountSpan.textContent = invoices.length;
            
             if (invoices.length === 0) {
                 savedInvoicesList.innerHTML = '<li>ç›®å‰æ²’æœ‰å·²å„²å­˜çš„ç™¼ç¥¨ã€‚</li>';
                 return;
            }
            
            invoices.forEach(inv => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${inv}</span>
                    <button class="delete-btn" onclick="deleteInvoice('${inv}')">[X] åˆªé™¤</button>
                `;
                savedInvoicesList.appendChild(li);
            });
        }
        
        // --- è¼”åŠ©å‡½å¼ï¼šåˆªé™¤ç™¼ç¥¨ ---
        window.deleteInvoice = function(invoiceNumber) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç™¼ç¥¨è™Ÿç¢¼ ${invoiceNumber} å—ï¼Ÿ`)) {
                const index = userInvoices[currentUser].indexOf(invoiceNumber);
                if (index > -1) {
                    userInvoices[currentUser].splice(index, 1);
                    renderSavedInvoices();
                    bulkResultMessage.textContent = '';
                    saveUserData(); // æ›´æ–° localStorage
                }
            }
        }
        
        // --- ç™»å…¥/ç™»å‡ºæ§åˆ¶ ---
        function updateAuthControls() {
            authControls.innerHTML = ''; 
            
            if (isAuthenticated) {
                const welcomeSpan = document.createElement('span');
                welcomeSpan.textContent = `æ­¡è¿ï¼Œ${currentUser}ï¼`;
                const logoutButton = document.createElement('button');
                logoutButton.textContent = 'ç™»å‡º';
                logoutButton.id = 'logout-btn';
                logoutButton.addEventListener('click', logout);

                authControls.appendChild(welcomeSpan);
                authControls.appendChild(logoutButton);
                
                invoiceManagement.style.display = 'block';
                renderSavedInvoices();
                showPage('invoice-section');

            } else {
                const loginButton = document.createElement('button');
                loginButton.textContent = 'ç™»å…¥';
                loginButton.id = 'login-btn';
                loginButton.addEventListener('click', () => showPage('login-section'));
                
                authControls.appendChild(loginButton);
                
                invoiceManagement.style.display = 'none';
                bulkResultMessage.textContent = '';
                showPage('invoice-section'); // ç™»å‡ºå¾Œä»ç„¶åœç•™åœ¨ç™¼ç¥¨å°çé é¢
            }
        }

        function logout() {
            isAuthenticated = false;
            currentUser = null;
            localStorage.removeItem(LS_CURRENT_USER); // ç§»é™¤ç™»å…¥ç‹€æ…‹
            alert('å·²ç™»å‡ºã€‚');
            updateAuthControls();
        }

        // --- å•Ÿå‹•å‡½å¼ ---
        document.addEventListener('DOMContentLoaded', () => {
             generateMonthOptions(); 
             updateAuthControls();
             
             document.getElementById('show-register-btn').addEventListener('click', () => {
                 document.getElementById('register-message').textContent = ''; 
                 document.getElementById('register-form').reset();
                 showPage('register-section');
             });
             
             document.getElementById('back-to-login-btn').addEventListener('click', () => {
                 showPage('login-section');
             });
        });


        // --- ç™»å…¥/è¨»å†Š/å„²å­˜ç™¼ç¥¨é‚è¼¯ ---
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            if (users[username] === password) {
                isAuthenticated = true;
                currentUser = username;
                localStorage.setItem(LS_CURRENT_USER, currentUser); // å„²å­˜ç™»å…¥ç‹€æ…‹
                if (!userInvoices[currentUser]) userInvoices[currentUser] = [];
                alert(`ç™»å…¥æˆåŠŸï¼æ­¡è¿ ${currentUser}`);
                updateAuthControls();
                loginForm.reset(); 
            } else {
                alert('ä½¿ç”¨è€…åç¨±æˆ–å¯†ç¢¼éŒ¯èª¤ï¼');
            }
        });

        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;
            
            const registerMessage = document.getElementById('register-message');
            registerMessage.textContent = '';

            if (password.length < 4) {
                 registerMessage.textContent = 'å¯†ç¢¼é•·åº¦å¿…é ˆè‡³å°‘ç‚º4å€‹å­—å…ƒã€‚';
                 registerMessage.style.color = 'red';
                 return;
            }
            if (password !== confirmPassword) {
                 registerMessage.textContent = 'å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´ã€‚';
                 registerMessage.style.color = 'red';
                 return;
            }
            if (username === '') {
                 registerMessage.textContent = 'ä½¿ç”¨è€…åç¨±ä¸èƒ½ç‚ºç©ºã€‚';
                 registerMessage.style.color = 'red';
                 return;
            }
            if (users.hasOwnProperty(username)) {
                registerMessage.textContent = 'ä½¿ç”¨è€…åç¨±å·²å­˜åœ¨ã€‚';
                registerMessage.style.color = 'red';
                return;
            }

            users[username] = password; 
            userInvoices[username] = []; 
            saveUserData(); // å„²å­˜ä½¿ç”¨è€…å’Œç™¼ç¥¨æ•¸æ“š
            registerMessage.textContent = 'è¨»å†ŠæˆåŠŸï¼è«‹è¿”å›ç™»å…¥é é¢ã€‚';
            registerMessage.style.color = 'green';
            
            setTimeout(() => {
                showPage('login-section');
                registerForm.reset();
                registerMessage.textContent = '';
            }, 1500);
        });
        
        window.saveInvoice = function() {
            saveMessage.textContent = '';
            const invNo = newInvoiceInput.value.trim();

            if (invNo.length !== 8 || !/^\d{8}$/.test(invNo)) {
                saveMessage.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„8ç¢¼æ•¸å­—ç™¼ç¥¨è™Ÿç¢¼ï¼';
                saveMessage.style.color = 'red';
                return;
            }
            
            if (userInvoices[currentUser].includes(invNo)) {
                 saveMessage.textContent = 'é€™å¼µç™¼ç¥¨è™Ÿç¢¼å·²ç¶“å„²å­˜éäº†ã€‚';
                 saveMessage.style.color = 'orange';
                 return;
            }

            userInvoices[currentUser].push(invNo);
            renderSavedInvoices(); 
            newInvoiceInput.value = ''; 
            bulkResultMessage.textContent = ''; 
            saveUserData(); // å„²å­˜ç™¼ç¥¨æ•¸æ“š
            
            saveMessage.textContent = `ç™¼ç¥¨è™Ÿç¢¼ ${invNo} å„²å­˜æˆåŠŸï¼`;
            saveMessage.style.color = 'green';
            
            setTimeout(() => saveMessage.textContent = '', 1500);
        }

        // --- è‡ªå‹•å°çé‚è¼¯ ---
        window.checkAllInvoices = function() {
            if (!isAuthenticated) {
                bulkResultMessage.textContent = 'è«‹å…ˆç™»å…¥æ‰èƒ½ä½¿ç”¨è‡ªå‹•å°çåŠŸèƒ½ã€‚';
                bulkResultMessage.style.color = 'orange';
                return;
            }
            
            const invoices = userInvoices[currentUser] || [];
            const selectedMonthKey = winningSelectBulk.value;
            const winningData = allWinningNumbers[selectedMonthKey];

            if (!winningData) {
                 bulkResultMessage.textContent = 'è«‹é¸æ“‡æœ‰æ•ˆçš„é–‹çæœŸåˆ¥ã€‚';
                 bulkResultMessage.style.color = 'red';
                 return;
            }
            if (invoices.length === 0) {
                bulkResultMessage.textContent = 'æ‚¨æ²’æœ‰å„²å­˜ä»»ä½•ç™¼ç¥¨ï¼Œè«‹å…ˆæ–°å¢ã€‚';
                bulkResultMessage.style.color = 'orange';
                return;
            }

            let foundWinner = invoices.some(invNo => isWinning(invNo, winningData));

            if (foundWinner) {
                bulkResultMessage.textContent = 'æ­å–œä½ ä¸­çäº†ï¼è«‹èˆ‡ç®¡ç†è€…è¯ç¹« ğŸ’°';
                bulkResultMessage.style.color = 'red';
            } else {
                bulkResultMessage.textContent = 'å¾ˆå¯æƒœï¼Œä½ æ²’ä¸­çï¼Œå†æ¥å†å² ğŸ™';
                bulkResultMessage.style.color = 'green';
            }
        }

        // --- å–®å¼µç™¼ç¥¨å°çé‚è¼¯ ---
        window.checkWinning = function() {
            const invNo = document.getElementById('invoice-number').value.trim();
            const resultMessage = document.getElementById('result-message');
            const selectedMonthKey = document.getElementById('winning-term-select').value; 
            const winningData = allWinningNumbers[selectedMonthKey];
            
            resultMessage.style.color = 'black';
            
            if (!winningData) {
                 resultMessage.textContent = 'è«‹å…ˆé¸æ“‡é–‹çæœŸåˆ¥ã€‚';
                 resultMessage.style.color = 'red';
                 return;
            }
            
            if (invNo.length !== 8 || !/^\d{8}$/.test(invNo)) {
                resultMessage.textContent = 'è«‹è¼¸å…¥8ç¢¼æ•¸å­—çš„ç™¼ç¥¨è™Ÿç¢¼ã€‚';
                return;
            }

            if (isWinning(invNo, winningData)) {
                resultMessage.textContent = 'æ­å–œä½ ä¸­çäº†ï¼è«‹èˆ‡ç®¡ç†è€…è¯ç¹« ğŸ’°';
                resultMessage.style.color = 'red';
            } else {
                 resultMessage.textContent = 'å¾ˆå¯æƒœï¼Œä½ æ²’ä¸­çï¼Œå†æ¥å†å² ğŸ™';
                 resultMessage.style.color = 'gray';
            }
        }
    </script>
</body>
</html>
